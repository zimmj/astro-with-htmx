---
import Button from '../components/ui/Button.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/signin');
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete('sb-access-token', {
      path: '/',
    });
    Astro.cookies.delete('sb-refresh-token', {
      path: '/',
    });
    return Astro.redirect('/signin');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', {
    path: '/',
  });
  Astro.cookies.delete('sb-refresh-token', {
    path: '/',
  });
  return Astro.redirect('/signin');
}

const email = session.data.user?.email;
---

<BaseLayout title="dashboard" description="Landing page for logedin users">
  <h1>Welcome {email}</h1>
  <p>We are happy to see you here</p>
  <form action="/api/auth/signout">
    <Button type="submit" variant="secondary"> Sign out</Button>
  </form>
</BaseLayout>
